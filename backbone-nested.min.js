/**
 * Backbone-Nested 2.0.1 - An extension of Backbone.js that keeps track of nested attributes
 *
 * http://afeld.github.com/backbone-nested/
 *
 * Copyright (c) 2011-2012 Aidan Feldman
 * MIT Licensed (LICENSE)
 */
/*global define, require, module */
(function(e,t){if(typeof exports!=="undefined"){module.exports=t(require("jquery"),require("underscore"),require("backbone"))}else if(typeof define==="function"&&define.amd){define(["jquery","underscore","backbone"],t)}else{t(e.$,e._,e.Backbone)}})(this,function(e,t,n){"use strict";var r=[],i;n.NestedModel=n.Model.extend({get:function(e){var r=n.NestedModel.attrPath(e),i;n.NestedModel.walkPath(this.attributes,r,function(e,n){var s=t.last(n);if(n.length===r.length){i=e[s]}});return i},has:function(e){var n=this.get(e);return!(n===null||t.isUndefined(n))},set:function(e,r,s){var o=n.NestedModel.deepClone(this.attributes),u,a,f;if(t.isString(e)){u=n.NestedModel.attrPath(e)}else if(t.isArray(e)){u=e}if(u){s=s||{};this._setAttr(o,u,r,s)}else{s=r||{};var l=e;for(var c in l){if(l.hasOwnProperty(c)){this._setAttr(o,n.NestedModel.attrPath(c),s.unset?void 0:l[c],s)}}}i=n.NestedModel.__super__.changedAttributes.call(this);if(s.unset&&u&&u.length===1){a={};a[e]=void 0;i=t.omit(i,t.keys(a));f=n.NestedModel.__super__.set.call(this,a,s)}else{a=o;if(s.unset&&u){s=t.extend({},s);delete s.unset}else if(s.unset&&t.isObject(e)){a=e}i=t.omit(i,t.keys(a));f=n.NestedModel.__super__.set.call(this,a,s)}if(!f){this.changed={};i={};return false}this._runDelayedTriggers();return this},unset:function(e,n){return this.set(e,void 0,t.extend({},n,{unset:true}))},clear:function(e){i={};e=e||{};var n=t.clone(this.attributes);if(!e.silent&&this.validate&&!this.validate(n,e)){return false}var r=this.changed={};var s=this;var o=function(e,n,i){t.each(e,function(u,a){var f=n;if(t.isArray(e)){f+="["+a+"]"}else if(n){f+="."+a}else{f=a}u=e[a];if(t.isObject(u)){o(u,f,i)}if(!i.silent)s._delayedChange(f,null,i);r[f]=null})};o(this.attributes,"",e);this.attributes={};if(!e.silent)this._delayedTrigger("change");this._runDelayedTriggers();return this},add:function(e,n,r){var i=this.get(e);if(!t.isArray(i))throw new Error("current value is not an array");return this.set(e+"["+i.length+"]",n,r)},remove:function(e,r){r=r||{};var i=n.NestedModel.attrPath(e),s=t.initial(i),o=this.get(s),u=t.last(i);if(!t.isArray(o)){throw new Error("remove() must be called on a nested array")}var a=!r.silent&&o.length>=u+1,f=o[u];o.splice(u,1);r.silent=true;this.set(s,o,r);if(a){e=n.NestedModel.createAttrStr(s);this.trigger("remove:"+e,this,f);for(var l=s.length;l>=1;l--){e=n.NestedModel.createAttrStr(t.first(s,l));this.trigger("change:"+e,this,f)}this.trigger("change",this,f)}return this},changedAttributes:function(e){var r=n.NestedModel.__super__.changedAttributes.call(this,e);if(t.isObject(r)){return t.extend({},i,r)}return false},toJSON:function(){return n.NestedModel.deepClone(this.attributes)},_delayedTrigger:function(){r.push(arguments)},_delayedChange:function(e,t,n){this._delayedTrigger("change:"+e,this,t,n);if(!this.changed){this.changed={}}this.changed[e]=t},_runDelayedTriggers:function(){while(r.length>0){this.trigger.apply(this,r.shift())}},_setAttr:function(e,r,i,s){s=s||{};var o=r.length;var u=this;n.NestedModel.walkPath(e,r,function(e,a,f){var l=t.last(a);var c=n.NestedModel.createAttrStr(a);var h=!t.isEqual(e[l],i);if(a.length===o){if(s.unset){delete e[l];if(t.isArray(e)){var p=n.NestedModel.createAttrStr(t.initial(r));u._delayedTrigger("remove:"+p,u,e[l])}}else{e[l]=i}if(!s.silent&&t.isObject(i)&&h){var d=[];var v=function(e,n){if(t.indexOf(d,e)>-1){return}else{d.push(e)}var r,i;for(var o in e){if(e.hasOwnProperty(o)){r=n+"."+o;i=e[o];if(!t.isEqual(u.get(r),i)){u._delayedChange(r,i,s)}if(t.isObject(i)){v(i,r)}}}};v(i,c)}}else if(!e[l]){if(t.isNumber(f)){e[l]=[]}else{e[l]={}}}if(!s.silent){if(a.length>1&&h){u._delayedChange(c,e[l],s)}if(t.isArray(e[l])){u._delayedTrigger("add:"+c,u,e[l])}}})}},{attrPath:function(e){var n;if(t.isString(e)){n=e===""?[""]:e.match(/[^\.\[\]]+/g);n=t.map(n,function(e){return e.match(/^\d+$/)?parseInt(e,10):e})}else{n=e}return n},createAttrStr:function(e){var n=e[0];t.each(t.rest(e),function(e){n+=t.isNumber(e)?"["+e+"]":"."+e});return n},deepClone:function(t){return e.extend(true,{},t)},walkPath:function(e,t,n,r){var i=e,s;for(var o=0;o<t.length;o++){n.call(r||this,i,t.slice(0,o+1),t[o+1]);s=t[o];i=i[s];if(!i)break}}});return n})
